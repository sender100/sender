<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‚ö° ID Data Share ‚Äî Text Only</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  :root{ --indigo:#6366f1; --green:#10b981; --red:#ef4444; --blue:#3b82f6 }
  body{ font-family:'Poppins',sans-serif; background:linear-gradient(120deg,#0ea5e9,#6366f1,#a855f7,#ec4899,#14b8a6); background-size:400% 400%; animation:move 18s ease infinite; min-height:100vh }
  @keyframes move{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
  .glass{ backdrop-filter:blur(14px); background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.25) }
  .card{ background:rgba(255,255,255,.95); border-radius:18px; box-shadow:0 24px 50px rgba(0,0,0,.2) }
  .f{ border:1px solid rgba(0,0,0,.1); border-radius:14px; padding:.8rem }
  .btn{ border-radius:14px; padding:.8rem 1rem; font-weight:700; color:#fff; cursor:pointer }
  .b-indigo{ background:linear-gradient(135deg,#6366f1,#a855f7) }
  .b-green{ background:linear-gradient(135deg,#10b981,#22c55e) }
  .b-red{ background:linear-gradient(135deg,#ef4444,#f97316) }
  .b-blue{ background:linear-gradient(135deg,#3b82f6,#06b6d4) }
  .badge{ font-size:.72rem; padding:.22rem .55rem; border-radius:999px; background:rgba(255,255,255,.22); color:#fff }
  .pill{ padding:.2rem .6rem; border-radius:999px; font-size:.7rem; background:#eef2ff; color:#4f46e5 }
</style>
</head>
<body>
  <div class="glass max-w-6xl mx-auto my-10 p-6 md:p-10 rounded-3xl animate__animated animate__fadeIn">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold text-white drop-shadow">‚ö° ID Data Share ‚Äî Text Only</h1>
      <span class="badge">E2E-Ready ‚Ä¢ Realtime</span>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- Sender -->
      <div class="card p-6">
        <h2 class="text-2xl font-bold text-indigo-600 mb-3">üì§ Sender</h2>
        <div class="space-y-3">
          <div class="flex gap-2">
            <input id="senderId" class="f flex-1" placeholder="Custom ID (optional)"/>
            <button id="genId" class="btn b-indigo">Generate</button>
            <button id="copyId" class="btn b-blue">Copy</button>
          </div>

          <textarea id="dataText" class="f w-full h-44" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ ‡§°‡§æ‡§ü‡§æ/‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≤‡§ø‡§ñ‡•á‡§Ç..."></textarea>

          <div class="grid grid-cols-2 gap-3">
            <input id="passphrase" class="f" placeholder="Passphrase (optional E2E)"/>
            <select id="expiry" class="f">
              <option value="0">No expiry</option>
              <option value="600000">10 min</option>
              <option value="3600000">1 hour</option>
              <option value="86400000">1 day</option>
              <option value="604800000">7 days</option>
            </select>
          </div>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="oneTime" type="checkbox"> Delete after first view (one-time)
          </label>

          <div class="grid grid-cols-2 gap-3">
            <button id="sendBtn" class="btn b-indigo w-full">üöÄ Send</button>
            <button id="delBtn" class="btn b-red w-full">üóëÔ∏è Delete ID</button>
          </div>

          <div>
            <div id="status" class="text-sm"></div>
            <div id="shareWrap" class="hidden mt-3">
              <label class="text-sm">Shareable link</label>
              <div class="flex gap-2 mt-1">
                <input id="shareLink" class="f flex-1" readonly>
                <button id="copyShare" class="btn b-blue">Copy Link</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Receiver -->
      <div class="card p-6">
        <h2 class="text-2xl font-bold text-green-600 mb-3">üì• Receiver</h2>
        <div class="space-y-3">
          <div class="flex gap-2">
            <input id="receiverId" class="f flex-1" placeholder="Enter ID to receive"/>
            <button id="openBtn" class="btn b-green">üîç Open</button>
            <button id="stopBtn" class="btn b-blue">‚úã Stop</button>
          </div>
          <input id="recvPass" class="f" placeholder="Passphrase (if encrypted)"/>
          <div id="countdown" class="text-xs opacity-75 hidden"></div>

          <div id="outCard" class="p-4 border rounded-xl hidden">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">Data <span id="meta" class="pill ml-2"></span></div>
              <div class="text-xs opacity-70" id="meta2"></div>
            </div>
            <pre id="out" class="whitespace-pre-wrap break-words text-sm"></pre>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="copyData" class="btn b-blue">Copy Data</button>
              <button id="verifyBtn" class="btn b-blue">Verify SHA-256</button>
            </div>
            <div id="verifyOut" class="text-xs opacity-80 mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="card p-6 mt-6">
      <h2 class="text-2xl font-bold text-blue-600 mb-4">üìú History</h2>
      <div class="flex gap-2 mb-3">
        <button id="tabSent" class="btn b-blue">Sent</button>
        <button id="tabRecv" class="btn b-blue">Received</button>
        <button id="clearHist" class="btn b-red">Clear Local</button>
      </div>
      <div id="histList" class="space-y-2 max-h-72 overflow-auto pr-1"></div>
    </div>
  </div>

  <!-- Firebase v11 (ES Modules) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, off, remove, get } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js';

    // ====== PUT YOUR REAL CONFIG ======
    const firebaseConfig = {
      apiKey: 'AIzaSyYOUR_KEY',
      authDomain: 'your-project.firebaseapp.com',
      databaseURL: 'https://your-project-default-rtdb.firebaseio.com',
      projectId: 'your-project',
      storageBucket: 'your-project.appspot.com',
      messagingSenderId: '0000000000',
      appId: '1:0000000000:web:xxxxxxxxxxxxxx'
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ---------- Utils ----------
    const $ = id => document.getElementById(id);
    function randomId(n=8){ const s='abcdefghijklmnopqrstuvwxyz0123456789'; let r=''; for(let i=0;i<n;i++) r+=s[Math.floor(Math.random()*s.length)]; return r }
    function toast(msg,type='info'){ const c=type==='ok'?'#10b981':type==='err'?'#ef4444':'#3b82f6'; const el=document.createElement('div'); el.textContent=msg; el.style.cssText=`position:fixed;right:12px;top:12px;background:${c};color:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:9999;`; document.body.appendChild(el); setTimeout(()=>el.remove(),1800) }
    function setShareLink(id){ const u=new URL(location.href); u.searchParams.set('id',id); $('shareLink').value=u.toString(); $('shareWrap').classList.remove('hidden') }

    // ---------- Local history ----------
    const HSENT='ids-text-sent', HREC='ids-text-recv';
    const getH=k=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}};
    const putH=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    let tab='sent';
    function renderHist(){
      const box=$('histList'); box.innerHTML='';
      const data=tab==='sent'?getH(HSENT):getH(HREC);
      if(!data.length){ box.innerHTML='<div class="text-sm opacity-70">Empty</div>'; return}
      data.slice(0,200).forEach(d=>{
        const row=document.createElement('div');
        row.className='p-2 rounded-lg border flex items-center justify-between bg-white';
        row.innerHTML=`<div><div class="font-semibold">${d.title}</div><div class="text-xs opacity-70">${d.time} ‚Ä¢ ID: ${d.id}</div></div>
        <div class="flex gap-2">
          <button class="btn b-blue" onclick="navigator.clipboard.writeText('${d.id}')">Copy ID</button>
          <a class="btn b-blue" target="_blank" href="${location.origin+location.pathname}?id=${d.id}">Open</a>
        </div>`;
        box.appendChild(row);
      });
    }
    $('tabSent').onclick=()=>{tab='sent';renderHist()}
    $('tabRecv').onclick=()=>{tab='recv';renderHist()}
    $('clearHist').onclick=()=>{ localStorage.removeItem(HSENT); localStorage.removeItem(HREC); renderHist(); toast('Local cleared','ok') }
    renderHist();

    // ---------- Crypto (text) ----------
    const enc = new TextEncoder(), dec = new TextDecoder();
    async function sha256(buf){ const h=await crypto.subtle.digest('SHA-256', buf); return btoa(String.fromCharCode(...new Uint8Array(h))) }
    function b642ab(b64){ const bin=atob(b64); const buf=new ArrayBuffer(bin.length); const v=new Uint8Array(buf); for(let i=0;i<bin.length;i++) v[i]=bin.charCodeAt(i); return buf }
    function ab2b64(buf){ let s=''; const v=new Uint8Array(buf); for(let i=0;i<v.length;i++) s+=String.fromCharCode(v[i]); return btoa(s) }
    async function deriveKey(pass,salt){
      const mat=await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:150000,hash:'SHA-256'}, mat, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt']);
    }
    async function encryptText(text,pass){
      const salt=crypto.getRandomValues(new Uint8Array(16));
      const iv=crypto.getRandomValues(new Uint8Array(12));
      const key=await deriveKey(pass,salt);
      const cipher=await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, enc.encode(text));
      const sha=await sha256(enc.encode(text));
      return {cipherB64:ab2b64(cipher), ivB64:ab2b64(iv), saltB64:ab2b64(salt), sha};
    }
    async function decryptText(cipherB64,pass,ivB64,saltB64){
      const key=await deriveKey(pass,new Uint8Array(b642ab(saltB64)));
      const plain=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(b642ab(ivB64))}, key, b642ab(cipherB64));
      return dec.decode(plain);
    }

    // ---------- Pre-fill from URL ----------
    (function(){ const q=new URL(location.href).searchParams.get('id'); if(q){ $('receiverId').value=q; toast('ID from URL'); startReceive(q) } })();

    // ---------- Sender ----------
    $('genId').onclick=()=>{ const id=randomId(8); $('senderId').value=id; navigator.clipboard.writeText(id); setShareLink(id); toast('ID generated','ok') };
    $('copyId').onclick=()=>{ const id=$('senderId').value.trim(); if(!id) return toast('No ID','err'); navigator.clipboard.writeText(id); setShareLink(id); toast('Copied','ok') };

    $('copyShare').onclick=()=>{ const v=$('shareLink').value; if(!v) return toast('No link','err'); navigator.clipboard.writeText(v); toast('Link copied','ok') };

    $('delBtn').onclick=async ()=>{
      const id=$('senderId').value.trim(); if(!id) return toast('No ID','err');
      if(!confirm(`Delete data for ID "${id}"?`)) return;
      try{ await remove(ref(db,'texts/'+id)); toast('Deleted','ok') }catch(e){ toast('Delete failed','err') }
    };

    $('sendBtn').onclick=async ()=>{
      const text=$('dataText').value; if(!text.trim()) return toast('Write some data','err');
      let id=$('senderId').value.trim() || randomId(8); $('senderId').value=id;
      const pass=$('passphrase').value.trim();
      const expiryMs=parseInt($('expiry').value,10)||0;
      const oneTime=$('oneTime').checked;

      // overwrite ask (if not expired)
      try{
        const existing=(await get(ref(db,'texts/'+id))).val();
        if(existing){ const expired = existing.expiresAt && Date.now()>existing.expiresAt; if(!expired){ const ok=confirm(`Data already exists for ID "${id}". Overwrite?`); if(!ok) return; } }
      }catch{}

      $('status').textContent='Processing...';
      try{
        let payload, sha;
        if(pass){
          const encPack=await encryptText(text,pass);
          payload={ enc:true, cipher:encPack.cipherB64, iv:encPack.ivB64, salt:encPack.saltB64, sha:encPack.sha, time:new Date().toISOString(), expiresAt: expiryMs? (Date.now()+expiryMs):null, oneTime, views:0 };
          sha=encPack.sha;
        }else{
          const bytes=enc.encode(text);
          sha=await sha256(bytes);
          payload={ enc:false, data:text, sha, time:new Date().toISOString(), expiresAt: expiryMs? (Date.now()+expiryMs):null, oneTime, views:0 };
        }
        await set(ref(db,'texts/'+id), payload);
        $('status').innerHTML=`‚úÖ Sent with ID <b>${id}</b> <span class="pill">SHA: ${sha.slice(0,10)}‚Ä¶</span>`;
        setShareLink(id);
        const item={id, title:(text.split('\n')[0]||'Data').slice(0,40), time:new Date().toLocaleString()};
        const arr=getH(HSENT); arr.unshift(item); putH(HSENT,arr); renderHist();
        toast('Sent','ok');
      }catch(e){ console.error(e); toast('Send failed','err') }
    };

    // ---------- Receiver ----------
    $('openBtn').onclick=()=>{ const id=$('receiverId').value.trim(); if(!id) return toast('Enter ID','err'); startReceive(id) };
    $('stopBtn').onclick=()=>{ stopReceive(); toast('Stopped') };

    let currentRef=null, countdownTimer=null;
    function stopReceive(){ if(currentRef){ off(currentRef); currentRef=null } if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null } $('countdown').classList.add('hidden') }
    function startCountdown(expiresAt){
      const el=$('countdown'); el.classList.remove('hidden');
      const tick=()=>{ const ms=Math.max(0,expiresAt-Date.now()); if(ms<=0){ el.textContent='‚è∞ Link expired'; clearInterval(countdownTimer); countdownTimer=null; } else { const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000); el.textContent=`‚è≥ Expires in ${m}m ${s}s`; } };
      tick(); countdownTimer=setInterval(tick,1000);
    }

    async function startReceive(id){
      stopReceive();
      $('outCard').classList.add('hidden');
      $('out').textContent='';
      currentRef=ref(db,'texts/'+id);
      onValue(currentRef, async snap=>{
        const data=snap.val();
        if(!data){ $('outCard').classList.add('hidden'); toast('No data for this ID','err'); return }
        if(data.expiresAt){ startCountdown(data.expiresAt); if(Date.now()>data.expiresAt){ $('outCard').classList.add('hidden'); return } }

        let text=''; const pass=$('recvPass').value.trim();
        try{
          if(data.enc){
            if(!pass){ toast('Passphrase required','err'); return }
            text = await decryptText(data.cipher, pass, data.iv, data.salt);
          }else{
            text = data.data||'';
          }
        }catch(e){ toast('Decrypt failed','err'); return }

        $('outCard').classList.remove('hidden');
        $('out').textContent=text;
        $('meta').textContent = data.enc? 'E2E' : 'Plain';
        $('meta2').textContent = `ID: ${id} ‚Ä¢ Views: ${data.views||0}`;

        // Copy + Verify
        $('copyData').onclick=()=>{ navigator.clipboard.writeText(text); toast('Copied','ok') };
        $('verifyBtn').onclick=async ()=>{
          const h=await sha256(enc.encode(text));
          $('verifyOut').textContent = h===data.sha ? '‚úÖ Hash verified (SHA-256 matches)' : '‚ùå Hash mismatch';
        };

        // bump views & one-time delete
        try{
          const snap2=await get(currentRef);
          const val=snap2.val(); if(val){ val.views=(val.views||0)+1; await set(currentRef,val) }
        }catch{}
        if(data.oneTime){ try{ await remove(currentRef) }catch{} }

        // history
        const arr=getH(HREC); arr.unshift({id, title:(text.split('\n')[0]||'Data').slice(0,40), time:new Date().toLocaleString()}); putH(HREC,arr); renderHist();
      });
    }
  </script>

  <!-- Example Firebase Rules (adjust as needed)
  {
    "rules": {
      "texts": {
        "$id": {
          ".read": true,
          ".write": true,
          ".validate": "
            (newData.hasChildren(['data']) || newData.hasChildren(['cipher','iv','salt'])) &&
            newData.child('time').isString()
          "
        }
      }
    }
  }
  -->
</body>
</html>
