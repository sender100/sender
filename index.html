import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Copy, Link as LinkIcon, Lock, LogIn, LogOut, Send, ShieldCheck, Trash2, Eye, Timer, CheckCircle2, XCircle, Search, StopCircle } from "lucide-react";
import { initializeApp } from "firebase/app";
import { getDatabase, ref as dbRef, set, onValue, off, remove, get } from "firebase/database";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "firebase/auth";

// ===================
// üîß Firebase Config
// ===================
// TODO: Replace with your real keys (or load from env)
const firebaseConfig = {
  apiKey: "AIzaSyYOUR_KEY",
  authDomain: "your-project.firebaseapp.com",
  databaseURL: "https://your-project-default-rtdb.firebaseio.com",
  projectId: "your-project",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "0000000000",
  appId: "1:0000000000:web:xxxxxxxxxxxxxx",
};

// Singletons
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ===================
// üîê Crypto helpers
// ===================
const enc = new TextEncoder();
const dec = new TextDecoder();

async function sha256(buf) {
  const h = await crypto.subtle.digest("SHA-256", buf);
  return btoa(String.fromCharCode(...new Uint8Array(h)));
}

function b642ab(b64) {
  const bin = atob(b64);
  const buf = new ArrayBuffer(bin.length);
  const v = new Uint8Array(buf);
  for (let i = 0; i < bin.length; i++) v[i] = bin.charCodeAt(i);
  return buf;
}

function ab2b64(buf) {
  let s = "";
  const v = new Uint8Array(buf);
  for (let i = 0; i < v.length; i++) s += String.fromCharCode(v[i]);
  return btoa(s);
}

async function deriveKey(pass, salt) {
  const mat = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, [
    "deriveKey",
  ]);
  return crypto.subtle.deriveKey(
    { name: "PBKDF2", salt, iterations: 150_000, hash: "SHA-256" },
    mat,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}

async function encryptText(text, pass) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pass, salt);
  const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, enc.encode(text));
  const sha = await sha256(enc.encode(text));
  return { cipherB64: ab2b64(cipher), ivB64: ab2b64(iv), saltB64: ab2b64(salt), sha };
}

async function decryptText(cipherB64, pass, ivB64, saltB64) {
  const key = await deriveKey(pass, new Uint8Array(b642ab(saltB64)));
  const plain = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: new Uint8Array(b642ab(ivB64)) },
    key,
    b642ab(cipherB64)
  );
  return dec.decode(plain);
}

// ===================
// üß∞ UI utilities
// ===================
function cx(...args) {
  return args.filter(Boolean).join(" ");
}

function toast(msg, type = "info") {
  const c = type === "ok" ? "#10b981" : type === "err" ? "#ef4444" : "#3b82f6";
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = `position:fixed;right:12px;top:12px;background:${c};color:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:9999;`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1800);
}

const HSENT = "ids-text-sent";
const HREC = "ids-text-recv";
const getH = (k) => {
  try {
    return JSON.parse(localStorage.getItem(k) || "[]");
  } catch {
    return [];
  }
};
const putH = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function randomId(n = 8) {
  const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from({ length: n }, () => chars[Math.floor(Math.random() * chars.length)]).join("");
}

function FancyCard({ title, subtitle, icon, children, right }) {
  return (
    <div className="bg-white/95 rounded-2xl shadow-xl border p-5">
      <div className="flex items-start justify-between mb-3">
        <div>
          <div className="flex items-center gap-2">
            {icon}
            <h3 className="text-xl font-bold">{title}</h3>
          </div>
          {subtitle && <div className="text-xs opacity-70 mt-1">{subtitle}</div>}
        </div>
        {right}
      </div>
      {children}
    </div>
  );
}

function Pill({ children }) {
  return <span className="px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-700">{children}</span>;
}

// ===================
// üöÄ Main App
// ===================
export default function App() {
  const [senderId, setSenderId] = useState("");
  const [dataText, setDataText] = useState("");
  const [passphrase, setPassphrase] = useState("");
  const [expiry, setExpiry] = useState("0");
  const [oneTime, setOneTime] = useState(false);
  const [status, setStatus] = useState("");
  const [shareUrl, setShareUrl] = useState("");

  const [receiverId, setReceiverId] = useState("");
  const [recvPass, setRecvPass] = useState("");
  const [recvText, setRecvText] = useState("");
  const [meta, setMeta] = useState({ kind: "", views: 0, id: "" });
  const [countdown, setCountdown] = useState("");
  const [isSignedIn, setIsSignedIn] = useState(false);

  const [histTab, setHistTab] = useState("sent");
  const [hist, setHist] = useState({ sent: getH(HSENT), recv: getH(HREC) });

  const subRef = useRef(null); // for db subscription
  const countdownTimer = useRef(null);

  // Prefill from URL ?id=...
  useEffect(() => {
    const u = new URL(window.location.href);
    const q = u.searchParams.get("id");
    if (q) {
      setReceiverId(q);
      toast("ID from URL");
    }
  }, []);

  // Auth state
  useEffect(() => {
    return onAuthStateChanged(auth, (user) => {
      setIsSignedIn(!!user);
      if (user && receiverId.trim()) startReceive(receiverId.trim());
    });
  }, [receiverId]);

  // Cleanup on unmount
  useEffect(() => () => stopReceive(), []);

  function setShareLink(id) {
    const u = new URL(window.location.href);
    u.searchParams.set("id", id);
    setShareUrl(u.toString());
  }

  function renderHist() {
    setHist({ sent: getH(HSENT), recv: getH(HREC) });
  }

  function stopReceive() {
    if (subRef.current) {
      off(subRef.current);
      subRef.current = null;
    }
    if (countdownTimer.current) {
      clearInterval(countdownTimer.current);
      countdownTimer.current = null;
    }
    setCountdown("");
  }

  function startCountdown(expiresAt) {
    const tick = () => {
      const ms = Math.max(0, expiresAt - Date.now());
      if (ms <= 0) {
        setCountdown("‚è∞ Link expired");
        clearInterval(countdownTimer.current);
        countdownTimer.current = null;
      } else {
        const m = Math.floor(ms / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        setCountdown(`‚è≥ Expires in ${m}m ${s}s`);
      }
    };
    tick();
    countdownTimer.current = setInterval(tick, 1000);
  }

  async function handleSend() {
    const text = dataText;
    if (!text.trim()) return toast("Write some data", "err");
    let id = (senderId || randomId(8)).trim();
    setSenderId(id);
    const pass = passphrase.trim();
    const expiryMs = parseInt(expiry, 10) || 0;

    try {
      const existing = (await get(dbRef(db, "texts/" + id))).val();
      if (existing) {
        const expired = existing.expiresAt && Date.now() > existing.expiresAt;
        if (!expired) {
          const ok = window.confirm(`Data already exists for ID "${id}". Overwrite?`);
          if (!ok) return;
        }
      }
    } catch {}

    setStatus("Processing...");

    try {
      let payload, sha;
      if (pass) {
        const encPack = await encryptText(text, pass);
        payload = {
          enc: true,
          cipher: encPack.cipherB64,
          iv: encPack.ivB64,
          salt: encPack.saltB64,
          sha: encPack.sha,
          time: new Date().toISOString(),
          expiresAt: expiryMs ? Date.now() + expiryMs : null,
          oneTime,
          views: 0,
        };
        sha = encPack.sha;
      } else {
        const bytes = enc.encode(text);
        sha = await sha256(bytes);
        payload = {
          enc: false,
          data: text,
          sha,
          time: new Date().toISOString(),
          expiresAt: expiryMs ? Date.now() + expiryMs : null,
          oneTime,
          views: 0,
        };
      }

      await set(dbRef(db, "texts/" + id), payload);
      setStatus(`‚úÖ Sent with ID ${id} ‚Äî SHA: ${payload.sha.slice(0, 10)}‚Ä¶`);
      setShareLink(id);
      try {
        await navigator.clipboard.writeText(id);
      } catch {}
      const s = getH(HSENT);
      s.unshift({ id, title: (text.split("\n")[0] || "Data").slice(0, 40), time: new Date().toLocaleString() });
      putH(HSENT, s);
      renderHist();
      toast("Sent", "ok");
    } catch (e) {
      console.error(e);
      toast("Send failed", "err");
      setStatus("");
    }
  }

  async function handleDelete() {
    const id = senderId.trim();
    if (!id) return toast("No ID", "err");
    if (!window.confirm(`Delete data for ID "${id}"?`)) return;
    try {
      await remove(dbRef(db, "texts/" + id));
      toast("Deleted", "ok");
    } catch (e) {
      toast("Delete failed", "err");
    }
  }

  async function startReceive(id) {
    if (!auth.currentUser) return toast("Login required", "err");
    stopReceive();
    setRecvText("");
    setMeta({ kind: "", views: 0, id: "" });

    const r = dbRef(db, "texts/" + id);
    subRef.current = r;
    onValue(r, async (snap) => {
      const data = snap.val();
      if (!data) {
        setRecvText("");
        toast("No data for this ID", "err");
        return;
      }

      if (data.expiresAt) {
        startCountdown(data.expiresAt);
        if (Date.now() > data.expiresAt) return;
      }

      let text = "";
      const pass = recvPass.trim();
      try {
        if (data.enc) {
          if (!pass) return toast("Passphrase required", "err");
          text = await decryptText(data.cipher, pass, data.iv, data.salt);
        } else {
          text = data.data || "";
        }
      } catch (e) {
        return toast("Decrypt failed", "err");
      }

      setRecvText(text);
      setMeta({ kind: data.enc ? "E2E" : "Plain", views: data.views || 0, id });

      try {
        const snap2 = await get(r);
        const val = snap2.val();
        if (val) {
          val.views = (val.views || 0) + 1;
          await set(r, val);
        }
      } catch {}

      if (data.oneTime) {
        try {
          await remove(r);
        } catch {}
      }

      const s = getH(HREC);
      s.unshift({ id, title: (text.split("\n")[0] || "Data").slice(0, 40), time: new Date().toLocaleString() });
      putH(HREC, s);
      renderHist();
    });
  }

  // ==============
  // JSX
  // ==============
  return (
    <div className="min-h-screen bg-gradient-to-tr from-sky-500 via-indigo-500 via-50% to-fuchsia-500 bg-[length:400%_400%] animate-[spin_18s_linear_infinite] p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-6">
        <header className="flex items-center justify-between text-white drop-shadow">
          <div>
            <h1 className="text-3xl md:text-4xl font-extrabold">‚ö° ID Data Share ‚Äî Receiver Login</h1>
            <p className="text-sm opacity-80">Text-only ‚Ä¢ E2E-Ready</p>
          </div>
          <Pill>Professional UI</Pill>
        </header>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Sender */}
          <FancyCard
            title="Sender"
            subtitle="Create or paste an ID, type your text, optionally encrypt, and send"
            icon={<Send className="h-5 w-5 text-indigo-600" />}
            right={
              <div className="flex gap-2">
                <button
                  className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-indigo-500 to-fuchsia-500 shadow"
                  onClick={() => {
                    const id = randomId(8);
                    setSenderId(id);
                    setShareLink(id);
                    navigator.clipboard.writeText(id).catch(() => {});
                    toast("ID generated", "ok");
                  }}
                >
                  Generate
                </button>
                <button
                  className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                  onClick={() => {
                    if (!senderId.trim()) return toast("No ID", "err");
                    setShareLink(senderId.trim());
                    navigator.clipboard.writeText(senderId.trim()).then(() => toast("Copied", "ok"));
                  }}
                >
                  Copy ID
                </button>
              </div>
            }
          >
            <div className="space-y-3">
              <div className="grid grid-cols-[1fr_auto] gap-2">
                <input
                  value={senderId}
                  onChange={(e) => setSenderId(e.target.value)}
                  placeholder="Custom ID (optional)"
                  className="border rounded-xl px-3 py-2"
                />
              </div>
              <textarea
                value={dataText}
                onChange={(e) => setDataText(e.target.value)}
                placeholder="‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü/‡§°‡§æ‡§ü‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‚Ä¶"
                className="border rounded-xl px-3 py-2 h-44 w-full"
              />
              <div className="grid grid-cols-2 gap-3">
                <input
                  value={passphrase}
                  onChange={(e) => setPassphrase(e.target.value)}
                  placeholder="Passphrase (optional E2E)"
                  className="border rounded-xl px-3 py-2"
                />
                <select
                  value={expiry}
                  onChange={(e) => setExpiry(e.target.value)}
                  className="border rounded-xl px-3 py-2"
                >
                  <option value="0">No expiry</option>
                  <option value="600000">10 min</option>
                  <option value="3600000">1 hour</option>
                  <option value="86400000">1 day</option>
                  <option value="604800000">7 days</option>
                </select>
              </div>
              <label className="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" checked={oneTime} onChange={(e) => setOneTime(e.target.checked)} />
                Delete after first view (one-time)
              </label>
              <div className="grid grid-cols-2 gap-3">
                <button
                  className="px-3 py-2 rounded-xl text-white font-bold bg-gradient-to-br from-indigo-500 to-fuchsia-500 shadow"
                  onClick={handleSend}
                >
                  üöÄ Send
                </button>
                <button
                  className="px-3 py-2 rounded-xl text-white font-bold bg-gradient-to-br from-rose-500 to-orange-500 shadow"
                  onClick={handleDelete}
                >
                  üóëÔ∏è Delete ID
                </button>
              </div>
              <div>
                <div className="text-sm">{status}</div>
                {!!shareUrl && (
                  <div className="mt-2">
                    <label className="text-sm">Shareable link</label>
                    <div className="flex gap-2 mt-1">
                      <input className="border rounded-xl px-3 py-2 flex-1" readOnly value={shareUrl} />
                      <button
                        className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                        onClick={() => {
                          if (!shareUrl) return toast("No link", "err");
                          navigator.clipboard.writeText(shareUrl).then(() => toast("Link copied", "ok"));
                        }}
                      >
                        Copy Link
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </FancyCard>

          {/* Receiver */}
          <FancyCard
            title="Receiver"
            subtitle="Login required to open and decrypt received data"
            icon={<Eye className="h-5 w-5 text-emerald-600" />}
            right={
              <div className="flex gap-2">
                {!isSignedIn ? (
                  <button
                    className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-emerald-500 to-green-500 shadow"
                    onClick={async () => {
                      try {
                        await signInWithPopup(auth, provider);
                        toast("Signed in", "ok");
                      } catch (e) {
                        toast("Login failed", "err");
                      }
                    }}
                  >
                    Sign in with Google
                  </button>
                ) : (
                  <button
                    className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-rose-500 to-red-500 shadow"
                    onClick={async () => {
                      try {
                        await signOut(auth);
                        toast("Signed out", "ok");
                      } catch (e) {
                        toast("Signout failed", "err");
                      }
                    }}
                  >
                    Sign out
                  </button>
                )}
              </div>
            }
          >
            <div className={cx("space-y-3", !isSignedIn && "opacity-60 pointer-events-none")}>
              <div className="flex gap-2">
                <input
                  value={receiverId}
                  onChange={(e) => setReceiverId(e.target.value)}
                  placeholder="Enter ID to receive"
                  className="border rounded-xl px-3 py-2 flex-1"
                />
                <button
                  className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-emerald-500 to-green-500 shadow"
                  onClick={() => {
                    if (!auth.currentUser) return toast("Login first", "err");
                    const id = receiverId.trim();
                    if (!id) return toast("Enter ID", "err");
                    startReceive(id);
                  }}
                >
                  üîç Open
                </button>
                <button
                  className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                  onClick={() => {
                    stopReceive();
                    toast("Stopped");
                  }}
                >
                  ‚úã Stop
                </button>
              </div>
              <input
                value={recvPass}
                onChange={(e) => setRecvPass(e.target.value)}
                placeholder="Passphrase (if encrypted)"
                className="border rounded-xl px-3 py-2"
              />
              {!!countdown && <div className="text-xs opacity-75">{countdown}</div>}

              {!!recvText && (
                <div className="p-4 border rounded-xl">
                  <div className="flex items-center justify-between mb-2">
                    <div className="font-semibold">
                      Data <span className="ml-2"><Pill>{meta.kind}</Pill></span>
                    </div>
                    <div className="text-xs opacity-70">ID: {meta.id} ‚Ä¢ Views: {meta.views}</div>
                  </div>
                  <pre className="whitespace-pre-wrap break-words text-sm">{recvText}</pre>
                  <div className="mt-3 flex flex-wrap gap-2">
                    <button
                      className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                      onClick={() => navigator.clipboard.writeText(recvText).then(() => toast("Copied", "ok"))}
                    >
                      Copy Data
                    </button>
                    <button
                      className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                      onClick={async () => {
                        const h = await sha256(enc.encode(recvText));
                        alert(
                          h === undefined
                            ? "Hash error"
                            : `SHA-256: ${h.slice(0, 10)}‚Ä¶\n(Compare with sender's preview)`
                        );
                      }}
                    >
                      Verify SHA-256
                    </button>
                  </div>
                </div>
              )}
            </div>
            {!isSignedIn && (
              <div className="text-xs opacity-70 mt-1">Login ‡§ï‡§∞‡•á‡§Ç, ‡§´‡§ø‡§∞ ID ‡§°‡§æ‡§≤‡§ï‡§∞ ‚ÄúOpen‚Äù ‡§¶‡§¨‡§æ‡§è‡§Å‡•§</div>
            )}
          </FancyCard>
        </div>

        {/* History */}
        <FancyCard title="History" subtitle="Local-only log on this device" icon={<Timer className="h-5 w-5 text-sky-600" />}> 
          <div className="flex gap-2 mb-3">
            <button
              onClick={() => setHistTab("sent")}
              className={cx(
                "px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow",
                histTab === "sent" && "ring-2 ring-offset-2"
              )}
            >
              Sent
            </button>
            <button
              onClick={() => setHistTab("recv")}
              className={cx(
                "px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow",
                histTab === "recv" && "ring-2 ring-offset-2"
              )}
            >
              Received
            </button>
            <button
              onClick={() => {
                localStorage.removeItem(HSENT);
                localStorage.removeItem(HREC);
                renderHist();
                toast("Local cleared", "ok");
              }}
              className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-rose-500 to-orange-500 shadow"
            >
              Clear Local
            </button>
          </div>

          <div className="space-y-2 max-h-72 overflow-auto pr-1">
            {(histTab === "sent" ? hist.sent : hist.recv).length === 0 ? (
              <div className="text-sm opacity-70">Empty</div>
            ) : (
              (histTab === "sent" ? hist.sent : hist.recv)
                .slice(0, 200)
                .map((d, i) => (
                  <div key={i} className="p-2 rounded-lg border flex items-center justify-between bg-white">
                    <div>
                      <div className="font-semibold">{d.title}</div>
                      <div className="text-xs opacity-70">{d.time} ‚Ä¢ ID: {d.id}</div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                        onClick={() => navigator.clipboard.writeText(d.id).then(() => toast("Copied", "ok"))}
                      >
                        Copy ID
                      </button>
                      <a
                        className="px-3 py-2 rounded-xl text-white font-semibold bg-gradient-to-br from-sky-500 to-cyan-500 shadow"
                        href={`${location.origin + location.pathname}?id=${d.id}`}
                        target="_blank"
                        rel="noreferrer"
                      >
                        Open
                      </a>
                    </div>
                  </div>
                ))
            )}
          </div>
        </FancyCard>

        {/* Footer notes */}
        <div className="text-center text-xs text-white/90">
          <div>Realtime DB rules must allow <span className="font-semibold">read: auth != null</span> and <span className="font-semibold">write: true</span> (or tighten as desired).</div>
          <div className="opacity-80">PBKDF2 150k ‚Ä¢ AES-GCM 256-bit ‚Ä¢ SHA-256 preview & verify ‚Ä¢ One-time + Expiry</div>
        </div>
      </div>
    </div>
  );
}
